default_platform(:ios)

# Load API Key from ~/.appstoreconnect/api_key.json
def load_api_key
  api_key_path = File.expand_path("~/.appstoreconnect/api_key.json")
  if File.exist?(api_key_path)
    api_key_data = JSON.parse(File.read(api_key_path))
    app_store_connect_api_key(
      key_id: api_key_data["key_id"],
      issuer_id: api_key_data["issuer_id"],
      key_content: api_key_data["key"],
      in_house: api_key_data["in_house"] || false
    )
  else
    UI.user_error!("API key not found at #{api_key_path}")
  end
end

platform :ios do
  desc "Run all tests"
  lane :test do
    scan(
      project: "GroqGo.xcodeproj",
      scheme: "GroqGo",
      devices: ["iPhone 16 Pro"],
      clean: true,
      output_types: "html,junit",
      output_directory: "./fastlane/test_output",
      skip_testing: ["GroqGoUITests/GroqGoUITests/testLaunchPerformance"]  # Skip flaky performance test
    )
  end

  desc "Build the app"
  lane :build do
    build_app(
      project: "GroqGo.xcodeproj",
      scheme: "GroqGo",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./fastlane/build",
      output_name: "GroqGo.ipa"
    )
  end

  desc "Register bundle ID on Apple Developer Portal"
  lane :register_app do
    # Use sigh to create the app identifier
    # This will trigger the creation if it doesn't exist
    sigh(
      app_identifier: "com.groqgo.app",
      team_id: "5BV85JW8US",
      api_key_path: File.expand_path("~/.appstoreconnect/api_key.json"),
      force: true
    )
  end

  desc "Upload to TestFlight (skip tests)"
  lane :beta_quick do
    # Load API key
    api_key = load_api_key

    # Ensure provisioning profile exists
    sigh(
      app_identifier: "com.groqgo.app",
      team_id: "5BV85JW8US",
      api_key_path: File.expand_path("~/.appstoreconnect/api_key.json"),
      force: true
    )

    # Get latest build number or default to 0 for new apps
    begin
      current_build = latest_testflight_build_number(api_key: api_key)
    rescue => e
      UI.message("No existing builds found, starting from 1")
      current_build = 0
    end

    # Increment build number
    increment_build_number(
      build_number: current_build + 1
    )

    # Build the app with automatic signing
    build_app(
      project: "GroqGo.xcodeproj",
      scheme: "GroqGo",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./fastlane/build",
      output_name: "GroqGo.ipa",
      export_options: {
        signingStyle: "automatic",
        teamID: "5BV85JW8US"
      }
    )

    # Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      notify_external_testers: false
    )
  end

  desc "Upload to TestFlight"
  lane :beta do
    # Load API key
    api_key = load_api_key

    # Run tests first
    test

    # Create app on App Store Connect if it doesn't exist
    begin
      produce(
        api_key: api_key,
        app_identifier: "com.groqgo.app",
        app_name: "GroqGo",
        language: "English",
        app_version: "1.0",
        sku: "com.groqgo.app.1",
        platform: "ios"
      )
    rescue => e
      UI.message("App already exists or creation handled: #{e.message}")
    end

    # Get latest build number or default to 0 for new apps
    begin
      current_build = latest_testflight_build_number(api_key: api_key)
    rescue => e
      UI.message("No existing builds found, starting from 1")
      current_build = 0
    end

    # Increment build number
    increment_build_number(
      build_number: current_build + 1
    )

    # Build the app with automatic signing
    build_app(
      project: "GroqGo.xcodeproj",
      scheme: "GroqGo",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./fastlane/build",
      output_name: "GroqGo.ipa"
    )

    # Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      notify_external_testers: false
    )
  end

  desc "Release to App Store"
  lane :release do
    # Build first
    build

    # Upload to App Store
    upload_to_app_store(
      skip_metadata: false,
      skip_screenshots: true,
      force: true
    )
  end

  # Error handling
  error do |lane, exception|
    puts "Error in lane #{lane}: #{exception.message}"
  end
end
